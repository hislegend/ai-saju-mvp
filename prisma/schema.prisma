generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

enum CalendarType {
  SOLAR
  LUNAR
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum ReadingStatus {
  CREATED
  REQUIRES_PAYMENT
  PROCESSING
  COMPLETED
  FAILED
}

enum ReadingMode {
  QUICK
  PREMIUM
}

enum OrderStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
}

model User {
  id            String        @id @default(cuid())
  name          String?
  phone         String?       @unique
  passwordHash  String?
  kakaoId       String?       @unique
  marketingOptIn Boolean      @default(false)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  profiles      Profile[]
  mbtiProfiles  MbtiProfile[]
  readings      Reading[]
  orders        Order[]
  eventLogs     EventLog[]
}

model Profile {
  id            String       @id @default(cuid())
  userId        String?
  name          String
  gender        Gender
  calendarType  CalendarType
  birthDate     DateTime
  birthTime     String?
  timeUnknown   Boolean      @default(false)
  isPrimary     Boolean      @default(false)
  createdAt     DateTime     @default(now())

  user          User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  readings      Reading[]
  mbtiProfiles  MbtiProfile[]

  @@index([userId])
}

model MbtiProfile {
  id           String     @id @default(cuid())
  userId       String?
  profileId    String?
  mbtiType     String
  confidence   Float
  source       String
  answers      Json?
  createdAt    DateTime   @default(now())

  user         User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  profile      Profile?   @relation(fields: [profileId], references: [id], onDelete: SetNull)
  readings     Reading[]

  @@index([userId])
  @@index([profileId])
}

model Reading {
  id              String        @id @default(cuid())
  userId          String?
  profileId       String
  mbtiProfileId   String?
  mode            ReadingMode
  productSlug     String?
  status          ReadingStatus @default(CREATED)
  marketingConsent Boolean      @default(false)
  sourceUtm       Json?
  resultVersion   Int           @default(1)
  previewText     String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user            User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  profile         Profile       @relation(fields: [profileId], references: [id], onDelete: Cascade)
  mbtiProfile     MbtiProfile?  @relation(fields: [mbtiProfileId], references: [id], onDelete: SetNull)
  sections        ReadingSection[]
  orders          Order[]
  couponRedeems   CouponRedeem[]
  eventLogs       EventLog[]

  @@index([userId])
  @@index([profileId])
  @@index([status])
}

model ReadingSection {
  id            String    @id @default(cuid())
  readingId     String
  sectionType   String
  title         String
  content       String
  displayOrder  Int

  reading       Reading   @relation(fields: [readingId], references: [id], onDelete: Cascade)

  @@index([readingId])
}

model Order {
  id             String      @id @default(cuid())
  readingId      String
  userId         String?
  orderNumber    String      @unique
  paymentMethod  String
  couponCode     String?
  amount         Int
  status         OrderStatus @default(PENDING)
  paymentUrl     String?
  clientSecret   String?
  pgTransactionId String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  reading        Reading     @relation(fields: [readingId], references: [id], onDelete: Cascade)
  user           User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([readingId])
  @@index([userId])
}

model Coupon {
  id             String    @id @default(cuid())
  code           String    @unique
  phone          String?
  discountAmount Int       @default(0)
  expiresAt      DateTime?
  maxUses        Int       @default(1)
  usedCount      Int       @default(0)
  active         Boolean   @default(true)
  createdAt      DateTime  @default(now())

  couponRedeems  CouponRedeem[]
}

model CouponRedeem {
  id          String    @id @default(cuid())
  couponId    String?
  readingId   String?
  code        String
  phone       String
  redeemed    Boolean   @default(true)
  redeemedAt  DateTime  @default(now())
  expiresAt   DateTime?
  meta        Json?

  coupon      Coupon?   @relation(fields: [couponId], references: [id], onDelete: SetNull)
  reading     Reading?  @relation(fields: [readingId], references: [id], onDelete: SetNull)

  @@index([couponId])
  @@index([readingId])
  @@unique([code, phone])
}

model EventLog {
  id          String    @id @default(cuid())
  userId      String?
  readingId   String?
  eventName   String
  utm         Json?
  device      Json?
  metadata    Json?
  createdAt   DateTime  @default(now())

  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  reading     Reading?  @relation(fields: [readingId], references: [id], onDelete: SetNull)

  @@index([eventName])
  @@index([userId])
  @@index([readingId])
}
